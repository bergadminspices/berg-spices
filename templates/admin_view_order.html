<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - View Order</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script>
    function toggleCommentBox() {
      let status = document.getElementById("status").value;
      let commentBox = document.getElementById("commentBox");
      if (status === "DELAYED" || status === "REFUND_INITIATED" || status === "REFUNDED") {
        commentBox.style.display = "block";
      } else {
        commentBox.style.display = "none";
      }
    }
  </script>
  <style>
    body { background: #fffdf5; }
    .card { border-radius: 15px; box-shadow: 0px 4px 12px rgba(0,0,0,0.1); }
    .table th, .table td { vertical-align: middle; }
  </style>
</head>
<body>
<div class="container mt-5">
  <h2 class="mb-4">Order Details - {{ order.order_id }}</h2>

  <!-- Customer Info -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Customer Information</h5>
      <p><strong>Name:</strong> {{ order.name }}</p>
      <p><strong>Phone:</strong> {{ order.phone }}</p>
      <p><strong>Email:</strong> {{ order.email }}</p>
	  <p class="mb-0 text-muted" style="white-space: pre-line;"><strong>Address: </strong>{{ order.address.replace(',', ',<br>') | safe }}</p>
	  
	  {% set status_color = {
		  'PLACED': 'secondary',
		  'PAYMENT_PENDING': 'warning',
		  'PREPARING': 'primary',
		  'SHIPPED': 'info',
		  'DELIVERED': 'success',
		  'DELAYED': 'danger',
		  'CANCELLED': 'dark',
		  'REFUND_INITIATED': 'warning',
		  'REFUNDED': 'success'
		} %}

	  
      <p><strong>Status:</strong> <span class="badge bg-{{ status_color.get(order.status, 'secondary') }}">
  {{ order.status }}</span></p>
    </div>
  </div>

  <!-- Items -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Ordered Items</h5>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Product</th>
            <th>Packet</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody>
          {% for item in order["items"] %}
          <tr>
            <td>{{ item.name }}</td>
            <td>{{ item.packet }}</td>
            <td>{{ item.qty }}</td>
            <td>₹{{ "%.2f"|format(item.price) }}</td>
            <td>₹{{ "%.2f"|format(item.subtotal) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <h5 class="text-end">Total: ₹{{ "%.2f"|format(order.total_amount) }}</h5>
    </div>
  </div>

  <!-- Update Status Form -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Update Order Status</h5>
      <form method="POST" action="{{ url_for('admin_update_order_status', order_id=order._id) }}">
		<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3">
          <label for="status" class="form-label">Change Status</label>
          
		  <select name="status" id="status" class="form-select" onchange="toggleCommentBox()">
		  <option value="PLACED" {% if order.status == "PLACED" %}selected{% endif %}>
			PLACED
		  </option>

		  <option value="PAYMENT_PENDING" {% if order.status == "PAYMENT_PENDING" %}selected{% endif %}>
			PAYMENT_PENDING
		  </option>

		  <option value="PREPARING" {% if order.status == "PREPARING" %}selected{% endif %}>
			PREPARING
		  </option>

		  <option value="SHIPPED" {% if order.status == "SHIPPED" %}selected{% endif %}>
			SHIPPED
		  </option>

		  <option value="DELIVERED" {% if order.status == "DELIVERED" %}selected{% endif %}>
			DELIVERED
		  </option>

		  <option value="DELAYED" {% if order.status == "DELAYED" %}selected{% endif %}>
			DELAYED
		  </option>

		  <option value="CANCELLED" {% if order.status == "CANCELLED" %}selected{% endif %}>
			CANCELLED
		  </option>

		  <option value="REFUND_INITIATED" {% if order.status == "REFUND_INITIATED" %}selected{% endif %}>
			REFUND_INITIATED
		  </option>

		  <option value="REFUNDED" {% if order.status == "REFUNDED" %}selected{% endif %}>
			REFUNDED
		  </option>

		</select>		  
		  
        </div>
        <div class="mb-3" id="commentBox" style="display:none;">
          
		  <label for="comment" class="form-label">Comment (required for DELAYED / REFUND actions)</label>
          
		  <textarea name="comment" id="comment" class="form-control" rows="3">{{ order.comment or "" }}</textarea>
        </div>
        <button type="submit" class="btn btn-success">Update Status</button>
      </form>
    </div>
  </div>

  <!-- Logs -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Order Logs</h5>
      {% if order.logs %}
      <ul class="list-group">
        {% for log in order.logs %}
        <li class="list-group-item">
          <strong>{{ log.timestamp }}</strong> → {{ log.action }}
          {% if log.comment %}<br><em>Comment: {{ log.comment }}</em>{% endif %}
        </li>
        {% endfor %}
      </ul>
      {% else %}
        <p>No actions logged yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- Back -->
  <a href="{{ url_for('admin_view_orders') }}" class="btn btn-secondary mt-4">Back to Orders</a>
</div>

<script>
  // Ensure correct display of comment box on page load
  toggleCommentBox();
</script>
</body>
</html>
