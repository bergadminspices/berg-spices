<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Profile - BERG SPICES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap" rel="stylesheet">

  <style>
    body { background: #fffdf5; }
    .page-title {
      font-family: 'Playfair Display', serif;
      color: #2e7d32;
      font-weight: bold;
    }
    .card { border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .btn-green { background: #2e7d32; color: white; }
    .btn-green:hover { background: #256428; }
    .strength-meter { height: 5px; border-radius: 3px; margin-top: 2px; }
    .strength-text { font-size: 0.85rem; margin-top: 2px; }
  </style>
</head>
<body>

{% include 'navbar.html' %}

<div class="container mt-5 mb-5">
  <h3 class="page-title mb-4">My Profile</h3>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endwith %}

  <div class="row g-4">

    <!-- PROFILE DETAILS -->
    <div class="col-md-6">
      <div class="card p-4">
        <h5 class="text-success mb-3">Profile Information</h5>

        <form method="POST" id="profileForm" novalidate>
			<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <input type="hidden" name="update_profile">

          <div class="mb-3">
            <label for="name" class="form-label">Name</label>
            <input type="text" name="name" id="name" class="form-control" 
                   value="{{ user.name }}" required pattern="[A-Za-z\s]+">
            <div class="invalid-feedback">Please enter a valid name (letters and spaces only).</div>
          </div>

          <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" id="email" class="form-control" value="{{ user.email }}" disabled>
          </div>

          <div class="mb-3">
            <label for="phone" class="form-label">Mobile</label>
            <input type="tel" name="phone" id="phone" class="form-control" 
                   value="{{ user.phone }}" required pattern="^\d{10}$">
            <div class="invalid-feedback">Enter a valid 10-digit mobile number.</div>
          </div>

          <div class="mb-3">
            <label for="address" class="form-label">Address</label>
            <textarea name="address" id="address" class="form-control" rows="3" required>{{ user.address }}</textarea>
            <div class="invalid-feedback">Address cannot be empty.</div>
          </div>

          <button type="submit" class="btn btn-green w-100">Save Profile</button>
        </form>
      </div>
    </div>

    <!-- CHANGE PASSWORD -->
    <div class="col-md-6">
      <div class="card p-4">
        <h5 class="text-success mb-3">Change Password</h5>

        <form method="POST" id="passwordForm" novalidate>
			<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <input type="hidden" name="change_password">

          <div class="mb-3">
            <label for="current_password" class="form-label">Current Password</label>
            <input type="password" name="current_password" id="current_password" class="form-control" required minlength="6">
            <div class="invalid-feedback">Current password required (min 6 characters).</div>
          </div>

          <div class="mb-3">
            <label for="new_password" class="form-label">New Password</label>
            <input type="password" name="new_password" id="new_password" class="form-control" required minlength="6">
            <div class="strength-meter bg-secondary"></div>
            <div class="strength-text text-muted">Password strength: -</div>
            <div class="invalid-feedback">New password must be at least 6 characters.</div>
          </div>

          <div class="mb-3">
            <label for="confirm_password" class="form-label">Confirm New Password</label>
            <input type="password" name="confirm_password" id="confirm_password" class="form-control" required minlength="6">
            <div class="invalid-feedback" id="confirmFeedback">Passwords do not match.</div>
          </div>

          <button type="submit" class="btn btn-success w-100">Change Password</button>
        </form>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function () {
  'use strict'

  // PROFILE FORM VALIDATION
  const profileForm = document.getElementById('profileForm');
  profileForm.addEventListener('submit', function (event) {
    if (!profileForm.checkValidity()) {
      event.preventDefault()
      event.stopPropagation()
    }
    profileForm.classList.add('was-validated')
  });

  // PASSWORD FORM VALIDATION
  const passwordForm = document.getElementById('passwordForm');
  const newPassword = document.getElementById('new_password');
  const confirmPassword = document.getElementById('confirm_password');
  const confirmFeedback = document.getElementById('confirmFeedback');
  const strengthMeter = newPassword.nextElementSibling;
  const strengthText = strengthMeter.nextElementSibling;

  // Password strength function
  function getStrength(pw) {
    let score = 0;
    if (pw.length >= 6) score++;
    if (/[A-Z]/.test(pw)) score++;
    if (/[a-z]/.test(pw)) score++;
    if (/[0-9]/.test(pw)) score++;
    if (/[\W]/.test(pw)) score++;
    return score;
  }

  newPassword.addEventListener('input', function() {
    const score = getStrength(newPassword.value);
    const colors = ['bg-secondary','bg-danger','bg-warning','bg-info','bg-success'];
    const labels = ['Weak','Weak','Medium','Good','Strong'];
    strengthMeter.className = 'strength-meter ' + colors[score-1] || 'bg-secondary';
    strengthText.textContent = 'Password strength: ' + (labels[score-1] || '-');
  });

  confirmPassword.addEventListener('input', function() {
    if (confirmPassword.value !== newPassword.value) {
      confirmPassword.setCustomValidity('Passwords do not match');
    } else {
      confirmPassword.setCustomValidity('');
    }
  });

  passwordForm.addEventListener('submit', function (event) {
    if (!passwordForm.checkValidity()) {
      event.preventDefault();
      event.stopPropagation();
    }
    passwordForm.classList.add('was-validated');
  });

  // Live input validation for name and phone
  document.getElementById('name').addEventListener('input', function() {
    this.value = this.value.replace(/[^A-Za-z\s]/g,'');
  });
  document.getElementById('phone').addEventListener('input', function() {
    this.value = this.value.replace(/[^0-9]/g,'').slice(0,10);
  });

})();
</script>
</body>
</html>
